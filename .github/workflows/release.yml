on:
  release:
    types:
    - created

name: release tlfs

jobs:
  tlfsc_linux:
    runs-on: self-hosted
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Install rust toolchain
      uses: hecrj/setup-rust-action@v1

    - name: Build tlfsc
      working-directory: tlfsc
      run: cargo build --release

    - name: Upload tlfsc
      working-directory: target/release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ github.event.release.tag_name }}
      run: gh release upload $TAG tlfsc -R $GITHUB_REPOSITORY --clobber

  tlfs_linux:
    runs-on: self-hosted
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Install rust toolchain
      uses: hecrj/setup-rust-action@v1

    - name: Build tlfs
      working-directory: api
      run: cargo build --release

    - name: Upload tlfs
      working-directory: target/release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ github.event.release.tag_name }}
      run: gh release upload $TAG libtlfs.so#x86_64-unknown-linux-gnu -R $GITHUB_REPOSITORY --clobber

  tlfs_android:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Install rust toolchain
      uses: hecrj/setup-rust-action@v1
      with:
        rust-version: "stable,nightly"
        targets: aarch64-linux-android

    - name: Install cargo apk
      run: cargo install cargo-apk

    - name: Build tlfs
      working-directory: api
      continue-on-error: true # currently this fails as cargo-apk ignores the [lib] name setting
      run: cargo +nightly apk build --release --target aarch64-linux-android

    - name: Upload tlfs
      working-directory: target/aarch64-linux-android/release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ github.event.release.tag_name }}
      run: gh release upload $TAG libtlfs.so#aarch64-linux-android -R $GITHUB_REPOSITORY --clobber
